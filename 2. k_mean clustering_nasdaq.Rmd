---
title: "K-Means Clustering"
author: "Yuanxi He"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

## Importing all packages
```{r, include=FALSE}
### Cleanup:
rm( list=ls() )

### Libraries:
library(ggplot2)
library(tseries)
library(moments)
library(sandwich)
library(lmtest)
library(stats)
library(ClusterR)
library(cluster)
library(dplyr)
library(plotly)
library(ggpubr)
library(factoextra)
library(NbClust)
library("scatterplot3d")
```

## Initial setting
```{r setup, warning=FALSE, message=FALSE}
## Importing data:

#getSymbols(Symbols = "^IXIC", auto_assign = TRUE, from = "1971-02-08")
#df<-as.data.frame(IXIC)
#rm(IXIC)
#save(df, file = "./data/nasdaq.RData")

load("./data/nasdaq.RData")

## Constructing variables:
dates <- as.Date(as.character(rownames(df)),'%Y-%m-%d')
T <- nrow(df)
price <- df[,6]
returns <- diff(log(price))*100
```


## Rolling: 
```{r}
### 5 years window:
rollapply(returns, FUN = mean, width = 252*5, by.column = TRUE)->m
rollapply(returns, FUN = sd, width = 252*5, by.column = TRUE)->std
rollapply(returns, FUN = skewness, width = 252*5, by.column = TRUE)->skew
rollapply(returns, FUN = kurtosis, width = 252*5, by.column = TRUE)->kurt

roll5y<-data.frame(dates = dates[1261:T],
                  na.omit(cbind(m,std,skew,kurt)))

rm(m,std,skew,kurt)

colMeans(roll5y[,c(2:5)])

### Year window:
rollapply(returns, FUN = mean, width = 252, by.column = TRUE)->m
rollapply(returns, FUN = sd, width = 252, by.column = TRUE)->std
rollapply(returns, FUN = skewness, width = 252, by.column = TRUE)->skew
rollapply(returns, FUN = kurtosis, width = 252, by.column = TRUE)->kurt

rolly<-data.frame(dates = dates[253:T],
                  na.omit(cbind(m,std,skew,kurt)))

rm(m,std,skew,kurt)

colMeans(rolly[,c(2:5)])

### Half year window:
rollapply(returns, FUN = mean, width = 126, by.column = TRUE)->m
rollapply(returns, FUN = sd, width = 126, by.column = TRUE)->std
rollapply(returns, FUN = skewness, width = 126, by.column = TRUE)->skew
rollapply(returns, FUN = kurtosis, width = 126, by.column = TRUE)->kurt

rollhy<-data.frame(dates = dates[127:T],
                  na.omit(cbind(m,std,skew,kurt)))

rm(m,std,skew,kurt)

colMeans(rollhy[,c(2:5)])

### Month window:
rollapply(returns, FUN = mean, width = 20, by.column = TRUE)->m
rollapply(returns, FUN = sd, width = 20, by.column = TRUE)->std
rollapply(returns, FUN = skewness, width = 20, by.column = TRUE)->skew
rollapply(returns, FUN = kurtosis, width = 20, by.column = TRUE)->kurt

rollm<-data.frame(dates = dates[21:T],
                  na.omit(cbind(m,std,skew,kurt)))

rm(m,std,skew,kurt)

colMeans(rollm[,c(2:5)])

### Window: week
rollapply(returns, FUN = mean, width = 5, by.column = TRUE)->m
rollapply(returns, FUN = sd, width = 5, by.column = TRUE)->std
rollapply(returns, FUN = skewness, width = 5, by.column = TRUE)->skew
rollapply(returns, FUN = kurtosis, width = 5, by.column = TRUE)->kurt

rollw<-data.frame(dates = dates[6:T],
                  na.omit(cbind(m,std,skew,kurt)))

rm(m,std,skew,kurt)

colMeans(rollw[,c(2:5)])
```

### Plots:
```{r}
####### 5 Years:
r5y_mean<-ggplot() +
  geom_line(mapping = aes(x = dates[1261:T], y = roll5y[,2]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Mean")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

r5y_std<-ggplot() +
  geom_line(mapping = aes(x = dates[1261:T], y = roll5y[,3]),col='tomato')+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Standard Deviation")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

r5y_skew<-ggplot() +
  geom_line(mapping = aes(x = dates[1261:T], y = roll5y[,4]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Skewness")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

r5y_kurt<-ggplot() +
  geom_line(mapping = aes(x = dates[1261:T], y = roll5y[,5]),col='tomato')+
  geom_hline(yintercept=3, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Kurtosis")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(r5y_mean, r5y_std, r5y_skew,r5y_kurt,
          ncol = 2, nrow = 2)

####### Yearly:
ry_mean<-ggplot() +
  geom_line(mapping = aes(x = dates[253:T], y = rolly[,2]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Mean")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ry_std<-ggplot() +
  geom_line(mapping = aes(x = dates[253:T], y = rolly[,3]),col='tomato')+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Standard Deviation")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ry_skew<-ggplot() +
  geom_line(mapping = aes(x = dates[253:T], y = rolly[,4]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Skewness")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ry_kurt<-ggplot() +
  geom_line(mapping = aes(x = dates[253:T], y = rolly[,5]),col='tomato')+
  geom_hline(yintercept=3, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Kurtosis")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(ry_mean, ry_std, ry_skew,ry_kurt,
          ncol = 2, nrow = 2)

####### Half year:
rhy_mean<-ggplot() +
  geom_line(mapping = aes(x = dates[127:T], y = rollhy[,2]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Mean")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rhy_std<-ggplot() +
  geom_line(mapping = aes(x = dates[127:T], y = rollhy[,3]),col='tomato')+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Standard Deviation")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rhy_skew<-ggplot() +
  geom_line(mapping = aes(x = dates[127:T], y = rollhy[,4]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Skewness")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rhy_kurt<-ggplot() +
  geom_line(mapping = aes(x = dates[127:T], y = rollhy[,5]),col='tomato')+
  geom_hline(yintercept=3, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Kurtosis")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(rhy_mean, rhy_std, rhy_skew,rhy_kurt,
          ncol = 2, nrow = 2)

####### Monthly:
rm_mean<-ggplot() +
  geom_line(mapping = aes(x = dates[21:T], y = rollm[,2]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Mean")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rm_std<-ggplot() +
  geom_line(mapping = aes(x = dates[21:T], y = rollm[,3]),col='tomato')+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Standard Deviation")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rm_skew<-ggplot() +
  geom_line(mapping = aes(x = dates[21:T], y = rollm[,4]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Skewness")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rm_kurt<-ggplot() +
  geom_line(mapping = aes(x = dates[21:T], y = rollm[,5]),col='tomato')+
  geom_hline(yintercept=3, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Kurtosis")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(rm_mean, rm_std, rm_skew,rm_kurt,
          ncol = 2, nrow = 2)

####### Weekly:
rw_mean<-ggplot() +
  geom_line(mapping = aes(x = dates[6:T], y = rollw[,2]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Mean")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rw_std<-ggplot() +
  geom_line(mapping = aes(x = dates[6:T], y = rollw[,3]),col='tomato')+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Standard Deviation")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rw_skew<-ggplot() +
  geom_line(mapping = aes(x = dates[6:T], y = rollw[,4]),col='tomato')+
  geom_hline(yintercept=0, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Skewness")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

rw_kurt<-ggplot() +
  geom_line(mapping = aes(x = dates[6:T], y = rollw[,5]),col='tomato')+
  geom_hline(yintercept=3, color = "darkblue")+
  scale_x_date(date_breaks = "5 year", date_labels = "%Y %b %d")+
  ylab("Kurtosis")+
  xlab("Dates")+
  theme_light()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggarrange(rw_mean, rw_std, rw_skew,rw_kurt,
          ncol = 2, nrow = 2)

rm(r5y_mean,r5y_std,r5y_skew,r5y_kurt,rhy_mean,rhy_std,rhy_skew,rhy_kurt,ry_mean,ry_std,ry_skew,ry_kurt,rm_mean,rm_std,rm_skew,rm_kurt,rw_mean,rw_std,rw_skew,rw_kurt)
```


## Clustering (Determining k):
```{r}
### Determining the optimal k:

# Elbow method
fviz_nbclust(rollm[,c(2:3)], kmeans, method = "wss") +
    geom_vline(xintercept = 3, linetype = 2) +
  labs(subtitle = "Elbow method")

# Silhouette method
fviz_nbclust(roll5y[,c(2:3)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rolly[,c(2:3)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollhy[,c(2:3)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollm[,c(2:3)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollw[,c(2:3)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

###########

fviz_nbclust(roll5y[,c(2:4)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rolly[,c(2:4)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollhy[,c(2:4)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollm[,c(2:4)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollw[,c(2:4)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")                          

###########

fviz_nbclust(roll5y[,c(2:5)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rolly[,c(2:5)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollhy[,c(2:5)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollm[,c(2:5)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")

fviz_nbclust(rollw[,c(2:5)], kmeans, method = "silhouette")+
  labs(subtitle = "Silhouette method")
```

## Clustering (5 years):
```{r}
######### Year windows (m+std):
set.seed(1111)
res11 <- kmeans(roll5y[,c(2:3)], centers = 2, nstart = 25)
res11$centers
y_kmeans11 <- as.character(res11$cluster)

ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = std, colour = y_kmeans11))+
  geom_point(mapping = aes_string(x = res11$centers[,1], y = res11$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = std, colour = y_kmeans111))+
  geom_point(mapping = aes_string(x = res111$centers[,1], y = res111$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot(data = as.data.frame(roll5y), aes(x = m, y = std, color = y_kmeans11)) + 
  geom_point()+
  stat_ellipse(type = "t",geom = "polygon", linetype = 1, alpha=0.05)+
  stat_ellipse(type = "norm", geom = "polygon", linetype = 2, alpha=0.05) +
  theme_light()

######### Year windows (m+std+skew):
set.seed(12345678)
res12 <- kmeans(roll5y[,c(2:4)], centers = 2, nstart = 25)
res12$centers
y_kmeans12 <- as.character(res12$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") if k=3
colors <- colors[as.numeric(res12$cluster)]
scatterplot3d(roll5y[,2:4], pch = 16, color=colors, grid=TRUE)

r5y_plot1<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = std, colour = y_kmeans12))+
  geom_point(mapping = aes_string(x = res12$centers[,1], y = res12$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot2<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = std, y = skew, colour = y_kmeans12))+
  geom_point(mapping = aes_string(x = res12$centers[,2], y = res12$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot3<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = skew, colour = y_kmeans12))+
  geom_point(mapping = aes_string(x = res12$centers[,1], y = res12$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggarrange(r5y_plot1, r5y_plot2, r5y_plot3,
          ncol = 1, nrow = 3)

rm(r5y_plot1, r5y_plot2, r5y_plot3)

######### Year windows (m+std+skew+kurt):
set.seed(11111)
res13 <- kmeans(roll5y[,c(2:5)], centers = 2, nstart = 25)
res13$centers
y_kmeans13 <- as.character(res13$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res3$cluster)]
par(mar=c(2,2,0.5,0.5), mfrow=c(2,2))
scatterplot3d(roll5y[,c(2,3,4)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(roll5y[,c(2,3,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(roll5y[,c(2,4,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(roll5y[,c(3,4,5)], pch = 16, color=colors, grid=TRUE)

r5y_plot4<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = std, colour = y_kmeans13))+
  geom_point(mapping = aes_string(x = res13$centers[,1], y = res13$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot5<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = skew, colour = y_kmeans13))+
  geom_point(mapping = aes_string(x = res13$centers[,1], y = res13$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot6<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = m, y = kurt, colour = y_kmeans13))+
  geom_point(mapping = aes_string(x = res13$centers[,1], y = res13$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot7<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = std, y = skew, colour = y_kmeans3))+
  geom_point(mapping = aes_string(x = res13$centers[,2], y = res13$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot8<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = std, y = kurt, colour = y_kmeans13))+
  geom_point(mapping = aes_string(x = res13$centers[,2], y = res13$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

r5y_plot9<-ggplot() +
  geom_point(data = as.data.frame(roll5y), mapping = aes(x = skew, y = kurt, colour = y_kmeans13))+
  geom_point(mapping = aes_string(x = res13$centers[,3], y = res13$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggarrange(r5y_plot4, r5y_plot5, r5y_plot6,r5y_plot7, r5y_plot8, r5y_plot9,
          ncol = 2, nrow = 3)

rm(r5y_plot4, r5y_plot5, r5y_plot6,r5y_plot7, r5y_plot8, r5y_plot9)
```

## Clustering (1 year):
```{r}
######### Year windows (m+std):
set.seed(12345)
res21 <- kmeans(rolly[,c(2:3)], centers = 2, nstart = 25)
res21$centers
y_kmeans21 <- as.character(res21$cluster)

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = std, colour = y_kmeans21))+
  geom_point(mapping = aes_string(x = res21$centers[,1], y = res21$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot(data = as.data.frame(rolly), aes(x = m, y = std, color = y_kmeans21)) + 
  geom_point()+
  stat_ellipse(type = "t",geom = "polygon", linetype = 1, alpha=0.05)+
  stat_ellipse(type = "norm", geom = "polygon", linetype = 2, alpha=0.05) +
  theme_light()

######### Year windows (m+std+skew):
set.seed(12345678)
res22 <- kmeans(rolly[,c(2:4)], centers = 2, nstart = 25)
res22$centers
y_kmeans22 <- as.character(res22$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res22$cluster)]
scatterplot3d(rolly[,2:4], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = std, colour = y_kmeans22))+
  geom_point(mapping = aes_string(x = res22$centers[,1], y = res22$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = std, y = skew, colour = y_kmeans22))+
  geom_point(mapping = aes_string(x = res22$centers[,2], y = res22$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = skew, colour = y_kmeans22))+
  geom_point(mapping = aes_string(x = res22$centers[,1], y = res22$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

######### Year windows (m+std+skew+kurt):
set.seed(12345)
res23 <- kmeans(rolly[,c(2:5)], centers = 2, nstart = 25)
res23$centers
y_kmeans23 <- as.character(res23$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res23$cluster)]
par(mfrow=c(2,2))
scatterplot3d(rolly[,c(2,3,4)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(2,3,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(2,4,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(3,4,5)], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = std, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,1], y = res23$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = skew, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,1], y = res23$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = m, y = kurt, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,1], y = res23$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = std, y = skew, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,2], y = res23$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = std, y = kurt, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,2], y = res23$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rolly), mapping = aes(x = skew, y = kurt, colour = y_kmeans23))+
  geom_point(mapping = aes_string(x = res23$centers[,3], y = res23$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()
```

## Clustering (half year):
```{r}
######### Year windows (m+std):
set.seed(11111)
res31 <- kmeans(rollhy[,c(2:3)], centers = 2, nstart = 25)
res31$centers
y_kmeans31 <- as.character(res31$cluster)

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = std, colour = y_kmeans31))+
  geom_point(mapping = aes_string(x = res31$centers[,1], y = res31$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot(data = as.data.frame(rollhy), aes(x = m, y = std, color = y_kmeans31)) + 
  geom_point()+
  stat_ellipse(type = "t",geom = "polygon", linetype = 1, alpha=0.05)+
  stat_ellipse(type = "norm", geom = "polygon", linetype = 2, alpha=0.05) +
  theme_light()

######### Year windows (m+std+skew):
set.seed(1111)
res32 <- kmeans(rollhy[,c(2:4)], centers = 2, nstart = 25)
res32$centers
y_kmeans32 <- as.character(res32$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res32$cluster)]
scatterplot3d(rollhy[,2:4], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = std, colour = y_kmeans32))+
  geom_point(mapping = aes_string(x = res32$centers[,1], y = res32$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = std, y = skew, colour = y_kmeans32))+
  geom_point(mapping = aes_string(x = res32$centers[,2], y = res32$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = skew, colour = y_kmeans32))+
  geom_point(mapping = aes_string(x = res32$centers[,1], y = res32$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

######### Year windows (m+std+skew+kurt):
set.seed(12345)
res33 <- kmeans(rollhy[,c(2:5)], centers = 2, nstart = 25)
res33$centers
y_kmeans33 <- as.character(res33$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res33$cluster)]
par(mfrow=c(2,2))
scatterplot3d(rolly[,c(2,3,4)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(2,3,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(2,4,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rolly[,c(3,4,5)], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = std, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,1], y = res33$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = skew, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,1], y = res33$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = m, y = kurt, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,1], y = res33$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = std, y = skew, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,2], y = res33$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = std, y = kurt, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,2], y = res33$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollhy), mapping = aes(x = skew, y = kurt, colour = y_kmeans33))+
  geom_point(mapping = aes_string(x = res33$centers[,3], y = res33$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()
```

## Clustering (1 month):
```{r}
######### Month windows (m+std):
set.seed(1234)
res41 <- kmeans(rollm[,c(2:3)], centers = 2, nstart = 25)
res41$centers
y_kmeans41 <- as.character(res41$cluster)

set.seed(123456789)
res411 <- kmeans(rollm[,c(2:3)], centers = 3, nstart = 25)
res411$centers
y_kmeans411 <- as.character(res411$cluster)

ggplot() +
  geom_point(data = rollm, mapping = aes(x = m, y = std, colour = y_kmeans411))+
  geom_point(mapping = aes_string(x = res411$centers[,1], y = res411$centers[,2]), color = "darkblue", size = 4, alpha=0.7)+
  ylab("Standard Deviation")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")
  
######### Month windows (m+std+skew):
set.seed(1234)
res42 <- kmeans(rollm[,c(2:4)], centers = 2, nstart = 25)
res42$centers
Clusters <- as.character(res42$cluster)

set.seed(12345678)
res422 <- kmeans(rollm[,c(2:4)], centers = 3, nstart = 25)
res422$centers
Clusters <- as.character(res422$cluster)

colors <- c("#66C2A5", "#FC8D62", "#8DA0CB")
colors1 <- colors[as.numeric(res42$cluster)]
colors2 <- colors[as.numeric(res422$cluster)]

scatterplot3d(rollm[,2:4], pch = 16, color=colors1, grid=TRUE)

scatterplot3d(rollm[,2:4], pch = 16, color=colors2, grid=TRUE)

p1<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = std, colour = Clusters))+
  geom_point(mapping = aes_string(x = res42$centers[,1], y = res42$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Standard Deviation")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p2<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = std, colour = Clusters))+
  geom_point(mapping = aes_string(x = res422$centers[,1], y = res422$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Standard Deviation")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p3<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res42$centers[,2], y = res42$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Standard Deviation')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p4<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res422$centers[,2], y = res422$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Standard Deviation')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p5<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res42$centers[,1], y = res42$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p6<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res422$centers[,1], y = res422$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

ggarrange(p1,p5,p3, common.legend = TRUE, ncol = 1, nrow = 3)

ggarrange(p2,p6,p4, common.legend = TRUE, ncol = 1, nrow = 3)

rm(p1,p2,p3,p4,p5,p6)

######### Month windows (m+std+skew+kurt):
set.seed(123456)
res43 <- kmeans(rollm[,c(2:5)], centers = 2, nstart = 25)
res43$centers
Clusters <- as.character(res43$cluster)

set.seed(12345678)
res433 <- kmeans(rollm[,c(2:5)], centers = 3, nstart = 25)
res433$centers
Clusters <- as.character(res433$cluster)

colors <- c("#66C2A5", "#FC8D62", "#8DA0CB")
colors1 <- colors[as.numeric(res43$cluster)]
colors2 <- colors[as.numeric(res433$cluster)]

par(mfrow=c(2,2))
scatterplot3d(rollm[,c(2,3,4)], pch = 16, color=colors1, grid=TRUE)
scatterplot3d(rollm[,c(2,3,5)], pch = 16, color=colors1, grid=TRUE)
scatterplot3d(rollm[,c(2,4,5)], pch = 16, color=colors1, grid=TRUE)
scatterplot3d(rollm[,c(3,4,5)], pch = 16, color=colors1, grid=TRUE)

par(mfrow=c(2,2))
scatterplot3d(rollm[,c(2,3,4)], pch = 16, color=colors2, grid=TRUE)
scatterplot3d(rollm[,c(2,3,5)], pch = 16, color=colors2, grid=TRUE)
scatterplot3d(rollm[,c(2,4,5)], pch = 16, color=colors2, grid=TRUE)
scatterplot3d(rollm[,c(3,4,5)], pch = 16, color=colors2, grid=TRUE)

p1<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = std, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,1], y = res43$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Standard Deviation")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p2<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,1], y = res43$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p3<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,1], y = res43$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Kurtosis")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p4<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,2], y = res43$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  xlab("Standard Deviation")+
  ylab('Skewness')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p5<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,2], y = res43$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  xlab("Standard Deviation")+
  ylab('Kurtosis')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p6<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = skew, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res43$centers[,3], y = res43$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Kurtosis")+
  xlab('Skewness')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

ggarrange(p1,p2,p3,p4,p5,p6, common.legend = TRUE, ncol = 2, nrow = 3)

p7<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = std, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,1], y = res433$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Standard Deviation")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p8<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,1], y = res433$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Skewness")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p9<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = m, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,1], y = res433$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Kurtosis")+
  xlab('Mean')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p10<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = skew, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,2], y = res433$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  xlab("Standard Deviation")+
  ylab('Skewness')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p11<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = std, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,2], y = res433$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  xlab("Standard Deviation")+
  ylab('Kurtosis')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

p12<-ggplot() +
  geom_point(data = as.data.frame(rollm), mapping = aes(x = skew, y = kurt, colour = Clusters))+
  geom_point(mapping = aes_string(x = res433$centers[,3], y = res433$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  ylab("Kurtosis")+
  xlab('Skewness')+
  scale_colour_brewer(palette = "Set2")+
  theme_light()+
  theme(legend.position="top")

ggarrange(p7,p8,p9,p10,p11,p12, common.legend = TRUE, ncol = 2, nrow = 3)

rm(p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11,p12)
```
## Clustering (1 week):
```{r}
######### Week windows (m+std):
set.seed(1111)
res51 <- kmeans(rollw[,c(2:3)], centers = 2, nstart = 25)
res51$centers
y_kmeans51 <- as.character(res51$cluster)

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = m, y = std, colour = y_kmeans51))+
  geom_point(mapping = aes_string(x = res51$centers[,1], y = res51$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

######### Week windows (m+std+skew):
set.seed(123)
res52 <- kmeans(rollw[,c(2:4)], centers = 2, nstart = 25)
res52$centers
y_kmeans52 <- as.character(res52$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res52$cluster)]
scatterplot3d(rollw[,2:4], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = m, y = std, colour = y_kmeans52))+
  geom_point(mapping = aes_string(x = res52$centers[,1], y = res52$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = std, y = skew, colour = y_kmeans52))+
  geom_point(mapping = aes_string(x = res52$centers[,2], y = res52$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = m, y = skew, colour = y_kmeans52))+
  geom_point(mapping = aes_string(x = res52$centers[,1], y = res52$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()


######### Month windows (m+std+skew+kurt):
set.seed(11111)
res53 <- kmeans(rollw[,c(2:5)], centers = 2, nstart = 25)
res53$centers
y_kmeans53 <- as.character(res53$cluster)

colors <- c("#F8766D", "#00BFC4")
# colors <- c("#F8766D" "#00BA38" "#619CFF") k=3
colors <- colors[as.numeric(res53$cluster)]
scatterplot3d(rollw[,c(2,3,4)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rollw[,c(2,3,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rollw[,c(2,4,5)], pch = 16, color=colors, grid=TRUE)
scatterplot3d(rollw[,c(3,4,5)], pch = 16, color=colors, grid=TRUE)

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = m, y = std, colour = y_kmeans53))+
  geom_point(mapping = aes_string(x = res53$centers[,1], y = res53$centers[,2]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = std, y = skew, colour = y_kmeans53))+
  geom_point(mapping = aes_string(x = res53$centers[,2], y = res53$centers[,3]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = std, y = kurt, colour = y_kmeans53))+
  geom_point(mapping = aes_string(x = res53$centers[,2], y = res53$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()

ggplot() +
  geom_point(data = as.data.frame(rollw), mapping = aes(x = skew, y = kurt, colour = y_kmeans53))+
  geom_point(mapping = aes_string(x = res53$centers[,3], y = res53$centers[,4]), 
               color = "darkblue", size = 4, alpha=0.7)+
  theme_light()
```



## Classify by clusters (5 yearly):
```{r}
dd_r5y<-cbind(roll5y,clust_1=y_kmeans11,clust_2=y_kmeans12,clust_3=y_kmeans13,price=df[,6][c(1261:T)])
dd_r5y<-dd_r5y[,-c(2:5)]

ggplot(dd_r5y, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_r5y, aes(x=dates,y=price, group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_r5y, aes(x=dates,y=price, group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_r5y, aes(x=dates,y=log(price), group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_r5y, aes(x=dates,y=log(price), group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_r5y, aes(x=dates,y=log(price), group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")
```

## Classify by clusters (yearly):
```{r}
dd_ry<-cbind(rolly,clust_1=y_kmeans21,clust_2=y_kmeans22,clust_3=y_kmeans23,price=df[,6][c(253:T)])
dd_ry<-dd_ry[,-c(2:5)]

ggplot(dd_ry, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_ry, aes(x=dates,y=price, group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_ry, aes(x=dates,y=price, group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_ry, aes(x=dates,y=log(price), group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_ry, aes(x=dates,y=log(price), group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_ry, aes(x=dates,y=log(price), group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")
```

## Classify by clusters (half yearly):
```{r}
dd_rhy<-cbind(rollhy,clust_1=y_kmeans31,clust_2=y_kmeans32,clust_3=y_kmeans33,price=df[,6][c(127:T)])
dd_rhy<-dd_rhy[,-c(2:5)]

ggplot(dd_rhy, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rhy, aes(x=dates,y=price, group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rhy, aes(x=dates,y=price, group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rhy, aes(x=dates,y=log(price), group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rhy, aes(x=dates,y=log(price), group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rhy, aes(x=dates,y=log(price), group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")
```

## Classify by clusters (monthly):
```{r}
dd_rm<-cbind(rollm,clust_1=y_kmeans41,clust_2=y_kmeans42,clust_3=y_kmeans43,price=df[,6][c(21:T)])
dd_rm<-dd_rm[,-c(2:5)]

ggplot(dd_rm, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  geom_bar(aes(y=price, fill=clust_1),stat="identity")+  
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(
    axis.title=element_text(size=10,face="bold"),
    axis.text.x = element_text(angle=60, hjust=1),
    legend.position="none")+
  scale_colour_brewer(palette = "Set2")

dd_rm_2<-cbind(rollm,clust_1=y_kmeans411,clust_2=y_kmeans42,clust_3=y_kmeans43,price=df[,6][c(21:T)])
dd_rm_2<-dd_rm_2[,-c(2:5)]

ggplot(dd_rm, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  geom_bar(aes(y=price, fill=clust_1),stat="identity")+  
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(
    axis.title=element_text(size=10,face="bold"),
    axis.text.x = element_text(angle=60, hjust=1),
    legend.position="none")+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rm, aes(x=dates,y=price, group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  geom_bar(aes(y=price, fill=clust_2),stat="identity")+  
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(
    axis.title=element_text(size=10,face="bold"),
    axis.text.x = element_text(angle=60, hjust=1),
    legend.position="none")+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rm, aes(x=dates,y=price, group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  geom_bar(aes(y=price, fill=clust_3),stat="identity")+  
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(
    axis.title=element_text(size=10,face="bold"),
    axis.text.x = element_text(angle=60, hjust=1),
    legend.position="none")+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rm, aes(x=dates,y=log(price), group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rm, aes(x=dates,y=log(price), group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rm, aes(x=dates,y=log(price), group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")
```

## Classify by clusters (weekly):
```{r}
dd_rw<-cbind(rollw,clust_1=y_kmeans51,clust_2=y_kmeans52,clust_3=y_kmeans53,price=df[,6][c(6:T)])
dd_rw<-dd_rw[,-c(2:5)]

ggplot(dd_rw, aes(x=dates,y=price, group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")+
  annotate("rect", xmin=as.Date('2000-01-06'), xmax=as.Date(c('2003-04-14')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2007-08-07'), xmax=as.Date(c('2010-01-04')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2010-05-06'), xmax=as.Date(c('2010-09-01')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2011-08-08'), xmax=as.Date(c('2012-01-01')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2018-12-07'), xmax=as.Date(c('2019-02-19')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2020-03-02'), xmax=as.Date(c('2020-07-01')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")+
  annotate("rect", xmin=as.Date('2022-02-11'), xmax=as.Date(c('2022-05-09')), ymin=-Inf , ymax=Inf, alpha=0.2,
           color="blue", fill="blue")

##########################

ggplot(dd_rw, aes(x=dates,y=price, group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rw, aes(x=dates,y=price, group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price")+
  xlab("Dates")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  scale_colour_brewer(palette = "Set2")

##########################

ggplot(dd_rw, aes(x=dates,y=log(price), group=clust_1, color=clust_1))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rw, aes(x=dates,y=log(price), group=clust_2, color=clust_2))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")

ggplot(dd_rw, aes(x=dates,y=log(price), group=clust_3, color=clust_3))+
  geom_point(size=0.5)+
  ylab("NASDAQ Stock price with log")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"))+
  theme_light()+
  scale_colour_brewer(palette = "Set2")
```


## Strategy (5 yearly):
```{r}
buy=0
sell=0
profit=0
normal_profit=0
for (i in 1:dim(dd_r5y)[1]) {  
    if (i==1) { 
      if (dd_r5y$clust_1==1){
        buy<-as.numeric(dd_r5y[i,5])
        }
    } 
    else if (dd_r5y[i,2]==2 & dd_r5y[i-1,2]==1) {
        sell<-as.numeric(sell+dd_r5y[i,5])
    } 
    else if (dd_r5y[i,2]==1 & dd_r5y[i-1,2]==2) {
        buy<-as.numeric(buy+dd_r5y[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_r5y[i,5]-dd_r5y[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_r5y)[1]) {   
    if (i==1) { 
      if (dd_r5y$clust_2==1){
        buy<-as.numeric(dd_r5y[i,5])
        }
    } 
    else if (dd_r5y[i,3]==2 & dd_r5y[i-1,3]==1) {
        sell<-as.numeric(sell+dd_r5y[i,5])
    } 
    else if (dd_r5y[i,3]==1 & dd_r5y[i-1,3]==2) {
        buy<-as.numeric(buy+dd_r5y[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_r5y[i,5]-dd_r5y[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_r5y)[1]) {   
  if (i==1) { 
    if (dd_r5y$clust_3==1){
      buy<-as.numeric(dd_r5y[i,5])
      }
  } 
  else if (dd_r5y[i,4]==2 & dd_r5y[i-1,4]==1) {
      sell<-as.numeric(sell+dd_r5y[i,5])
  } 
  else if (dd_r5y[i,4]==1 & dd_r5y[i-1,4]==2) {
      buy<-as.numeric(buy+dd_r5y[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_r5y[i,5]-dd_r5y[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_r5y, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))
```

## Strategy (yearly):
```{r}
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_ry)[1]) {   
    if (i==1) { 
      if (dd_ry$clust_1==1){
        buy<-as.numeric(dd_ry[i,5])
        }
    } 
    else if (dd_ry[i,2]==2 & dd_ry[i-1,2]==1) {
        sell<-as.numeric(sell+dd_ry[i,5])
    } 
    else if (dd_ry[i,2]==1 & dd_ry[i-1,2]==2) {
        buy<-as.numeric(buy+dd_ry[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_ry[i,5]-dd_ry[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_ry, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_ry)[1]) {   
    if (i==1) { 
      if (dd_ry$clust_2==1){
        buy<-as.numeric(dd_ry[i,5])
        }
    } 
    else if (dd_ry[i,3]==2 & dd_ry[i-1,3]==1) {
        sell<-as.numeric(sell+dd_ry[i,5])
    } 
    else if (dd_ry[i,3]==1 & dd_ry[i-1,3]==2) {
        buy<-as.numeric(buy+dd_ry[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_ry[i,5]-dd_ry[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_ry, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_ry)[1]) {   
  if (i==1) { 
    if (dd_ry$clust_3==1){
      buy<-as.numeric(dd_ry[i,5])
      }
  } 
  else if (dd_ry[i,4]==2 & dd_ry[i-1,4]==1) {
      sell<-as.numeric(sell+dd_ry[i,5])
  } 
  else if (dd_ry[i,4]==1 & dd_ry[i-1,4]==2) {
      buy<-as.numeric(buy+dd_ry[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_ry[i,5]-dd_ry[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_ry, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_ry, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))
```

## Strategy (half yearly):
```{r}
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rhy)[1]) {   
    if (i==1) { 
      if (dd_rhy$clust_1==1){
        buy<-as.numeric(dd_rhy[i,5])
        }
    } 
    else if (dd_rhy[i,2]==2 & dd_rhy[i-1,2]==1) {
        sell<-as.numeric(sell+dd_rhy[i,5])
    } 
    else if (dd_rhy[i,2]==1 & dd_rhy[i-1,2]==2) {
        buy<-as.numeric(buy+dd_rhy[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_rhy[i,5]-dd_rhy[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rhy)[1]) {   
    if (i==1) { 
      if (dd_rhy$clust_2==1){
        buy<-as.numeric(dd_rhy[i,5])
        }
    } 
    else if (dd_rhy[i,3]==2 & dd_rhy[i-1,3]==1) {
        sell<-as.numeric(sell+dd_rhy[i,5])
    } 
    else if (dd_rhy[i,3]==1 & dd_rhy[i-1,3]==2) {
        buy<-as.numeric(buy+dd_rhy[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_rhy[i,5]-dd_rhy[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rhy)[1]) {   
  if (i==1) { 
    if (dd_rhy$clust_3==1){
      buy<-as.numeric(dd_rhy[i,5])
      }
  } 
  else if (dd_rhy[i,4]==2 & dd_rhy[i-1,4]==1) {
      sell<-as.numeric(sell+dd_rhy[i,5])
  } 
  else if (dd_rhy[i,4]==1 & dd_rhy[i-1,4]==2) {
      buy<-as.numeric(buy+dd_rhy[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rhy[i,5]-dd_rhy[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_rhy, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))
```

## Strategy (monthly):
```{r}
### Monthly: 
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rm)[1]) {   
    if (i==1) { 
      if (dd_rm$clust_1==1){
        buy<-as.numeric(dd_rm[i,5])
        }
    } 
    else if (dd_rm[i,2]==2 & dd_rm[i-1,2]==1) {
        sell<-as.numeric(sell+dd_rm[i,5])
    } 
    else if (dd_rm[i,2]==1 & dd_rm[i-1,2]==2) {
        buy<-as.numeric(buy+dd_rm[i,5])
    } 
    profit[i]<-as.vector(print(sell-buy))
    normal_profit[i]<-as.vector(print(dd_rm[i,5]-dd_rm[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rm, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle=60, hjust=1),
        legend.position = 'none')

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rm)[1]) {   
  if (i==1) { 
    if (dd_rm$clust_2==1){
      buy<-as.numeric(dd_rm[i,5])
      }
  } 
  else if (dd_rm[i,3]==2 & dd_rm[i-1,3]==1) {
      sell<-as.numeric(sell+dd_rm[i,5])
  } 
  else if (dd_rm[i,3]==1 & dd_rm[i-1,3]==2) {
      buy<-as.numeric(buy+dd_rm[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rm[i,5]-dd_rm[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rm, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rm)[1]) {   
  if (i==1) { 
    if (dd_rm$clust_3==1){
      buy<-as.numeric(dd_rm[i,5])
      }
  } 
  else if (dd_rm[i,4]==2 & dd_rm[i-1,4]==1) {
      sell<-as.numeric(sell+dd_rm[i,5])
  } 
  else if (dd_rm[i,4]==1 & dd_rm[i-1,4]==2) {
      buy<-as.numeric(buy+dd_rm[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rm[i,5]-dd_rm[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rm, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#### Plot:
ggplot(dd_rm, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(limits = as.Date(c('1995-01-03','2022-05-13')),date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))+
  theme_light()

ggplot(dd_rm, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "4 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),
        axis.text.x = element_text(angle=60, hjust=1),
        legend.position = 'none')
```

## Strategy (weekly):
```{r}
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rw)[1]) {   
  if (i==1) { 
    if (dd_rw$clust_1==1){
      buy<-as.numeric(dd_rw[i,5])
      }
  } 
  else if (dd_rw[i,2]==2 & dd_rw[i-1,2]==1) {
      sell<-as.numeric(sell+dd_rw[i,5])
  } 
  else if (dd_rw[i,2]==1 & dd_rw[i-1,2]==2) {
      buy<-as.numeric(buy+dd_rw[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rw[i,5]-dd_rw[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rw, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rw)[1]) {   
  if (i==1) { 
    if (dd_rw$clust_2==1){
      buy<-as.numeric(dd_rw[i,5])
      }
  } 
  else if (dd_rw[i,3]==2 & dd_rw[i-1,3]==1) {
      sell<-as.numeric(sell+dd_rw[i,5])
  } 
  else if (dd_rw[i,3]==1 & dd_rw[i-1,3]==2) {
      buy<-as.numeric(buy+dd_rw[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rw[i,5]-dd_rw[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rw, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_2, color=clust_2), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_2),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

#######################
buy=0
sell=0
profit=0
normal_profit=0

for (i in 1:dim(dd_rw)[1]) {   
  if (i==1) { 
    if (dd_rw$clust_3==1){
      buy<-as.numeric(dd_rw[i,5])
      }
  } 
  else if (dd_rw[i,4]==2 & dd_rw[i-1,4]==1) {
      sell<-as.numeric(sell+dd_rw[i,5])
  } 
  else if (dd_rw[i,4]==1 & dd_rw[i-1,4]==2) {
      buy<-as.numeric(buy+dd_rw[i,5])
  } 
  profit[i]<-as.vector(print(sell-buy))
  normal_profit[i]<-as.vector(print(dd_rw[i,5]-dd_rw[1,5]))
}

tail(profit, n=1)
tail(normal_profit, n=1)

ggplot(dd_rw, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_3, color=clust_3), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_3),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))


#######################
dd_rw<-cbind(dd_rw,profit)

ggplot(dd_rw, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(limits = as.Date(c('1995-01-03','2022-05-13')),date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))

ggplot(dd_rw, aes(x=dates)) + 
  geom_point(aes(y = price, group=clust_1, color=clust_1), size=0.5) + 
  geom_bar(aes(y=normal_profit-profit, fill=clust_1),stat="identity")+  
  scale_fill_brewer(palette="Set2")+
  scale_colour_brewer(palette = "Set2")+
  scale_x_date(limits = as.Date(c('1995-01-03','2022-05-13')),date_breaks = "2 year", date_labels = "%Y %b %d")+
  ylab("NASDAQ Stock price and profit")+
  xlab("Dates")+
  theme_light()+
  theme(axis.title=element_text(size=10,face="bold"),axis.text.x = element_text(angle=60, hjust=1))
```